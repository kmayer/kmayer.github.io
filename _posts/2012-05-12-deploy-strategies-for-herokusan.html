---
layout: post
title: Deploy Strategies for HerokuSan
date: 2012-05-12 14:34:35.000000000 -07:00
tags:
- deploy
- heroku
---
<h1>Deploy Strategies</h1>
<p>If you look at the network graphs of <code>heroku_san</code> on github, you'll see a number of branches where the only change is the deletion of the following line from the <code>deploy</code> task:</p>

{% highlight ruby %}
stage.migrate
{% endhighlight %}

<p>If more than a few people are willing to take the effort to fork a gem just so they can delete 1 line, something smells. The reason is that these forkers were using something other than Rails+ActiveRecord+SQL in their project. Some were using Sinatra, others were using Rails, but with CouchDB.</p>
<p>The <em>raison d'Ãªtre</em> for the <code>heroku_san</code> gem is to make Heroku deploys dirt simple. So, if people are making whole forks to customize the deploy task, we should make it less painful.</p>
<h2>Enter strategies</h2>
<p><a href="http://en.wikipedia.org/wiki/Strategy_pattern">Strategies</a> are an object oriented programming pattern for creating pluggable execution control. Now, there is a new class of objects that inherit from <code>HerokuSan::Deploy::Base</code>. These objects control how deploys are executed for you. The Rails strategy, <code>HerokuSan::Deploy::Rails</code> does exactly what HerokuSan has always done:</p>
<ul>
<li>push to git@heroku.com</li>
<li>call rake db:migrate</li>
<li>restart</li>
</ul>
<p>On the other hand, the Sinatra strategy, <code>HerokuSan::Deploy::Sinatra</code> does nothing more than the base strategy:</p>
<ul>
<li>push to git@heroku.com</li>
</ul>
<p>You can create your own strategies and then configure HerokuSan to use it instead of its default:</p>
<h2>Rails 3 projects</h2>
<p>Amend your <code>Rakefile</code>:</p>

{% highlight ruby %}
require 'heroku_san'

class MyStrategy < HerokuSan::Deploy::Base
  def deploy
    super
    # call my own code to do something unique
  end
end

HerokuSan.project = HerokuSan::Project.new(Rails.root.join("config","heroku.yml"), :deploy => MyStrategy)
{% endhighlight %}

<h2>Sinatra (and other Rack based apps)</h2>
<p>Amend your <code>Rakefile</code></p>

{% highlight ruby %}
require 'heroku_san'

class MyStrategy < HerokuSan::Deploy::Base
  def deploy
    super
    # call my own code to do something unique
  end
end

config_file = File.join(File.expand_path(File.dirname(__FILE__)), 'config', 'heroku.yml')
HerokuSan.project = HerokuSan::Project.new(config_file, :deploy => MyStrategy)

load "heroku_san/tasks.rb"
{% endhighlight %}